From 8df19db84bfd6e92f2e53442d7d3342096d355b9 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Guido=20G=C3=BCnther?= <agx@sigxcpu.org>
Date: Fri, 16 Oct 2020 10:51:52 +0200
Subject: [PATCH] osk-button: Show/hide depending on a11y setting
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

This makes sure we don't show the button even though
squeekboard would not unfold.

Closes: #363

Signed-off-by: Guido GÃ¼nther <guido.gunther@puri.sm>
---
 src/osk/osk-button.c | 15 +++++++++++++++
 src/ui/home.ui       |  2 +-
 2 files changed, 16 insertions(+), 1 deletion(-)

diff --git a/src/osk/osk-button.c b/src/osk/osk-button.c
index 81c87142..0e411723 100644
--- a/src/osk/osk-button.c
+++ b/src/osk/osk-button.c
@@ -81,6 +81,19 @@ on_osk_visibility_changed (PhoshOskButton *self, GParamSpec *pspec, PhoshOskMana
 }
 
 
+static gboolean
+on_idle (PhoshOskButton *self)
+{
+  g_autoptr (GSettings) settings = NULL;
+
+  settings = g_settings_new ("org.gnome.desktop.a11y.applications");
+  g_settings_bind (settings, "screen-keyboard-enabled",
+                   self, "visible", G_SETTINGS_BIND_GET);
+
+  return FALSE;
+}
+
+
 static void
 phosh_osk_button_constructed (GObject *object)
 {
@@ -116,6 +129,8 @@ phosh_osk_button_constructed (GObject *object)
 
   on_osk_availability_changed (self, NULL, self->osk);
   on_osk_visibility_changed (self, NULL, self->osk);
+
+  g_idle_add ((GSourceFunc) on_idle, self);
 }
 
 
diff --git a/src/ui/home.ui b/src/ui/home.ui
index 9f733a32..a30205b9 100644
--- a/src/ui/home.ui
+++ b/src/ui/home.ui
@@ -41,7 +41,7 @@
             </child>
             <child>
               <object class="PhoshOskButton" id="btn_osk">
-		<property name="visible">True</property>
+		<property name="visible">False</property>
 		<property name="can_focus">True</property>
 		<property name="halign">end</property>
 		<property name="valign">center</property>
-- 
2.26.2

