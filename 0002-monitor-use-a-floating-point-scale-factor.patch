From 8131e43b59b374912b0555fcd377aae317e2d149 Mon Sep 17 00:00:00 2001
From: Arnaud Ferraris <arnaud.ferraris@collabora.com>
Date: Thu, 23 Apr 2020 18:37:04 +0200
Subject: [PATCH 2/2] monitor: use a floating-point scale factor

---
 src/monitor/monitor.c | 10 ++++++++--
 src/monitor/monitor.h |  3 ++-
 src/shell.c           |  6 +++---
 3 files changed, 13 insertions(+), 6 deletions(-)

diff --git a/src/monitor/monitor.c b/src/monitor/monitor.c
index 1498a21..d40e377 100644
--- a/src/monitor/monitor.c
+++ b/src/monitor/monitor.c
@@ -88,7 +88,7 @@ output_handle_scale (void             *data,
   PhoshMonitor *self = PHOSH_MONITOR (data);
 
   self->wl_output_done = FALSE;
-  self->scale = scale;
+  self->scale = (double) scale;
 }
 
 
@@ -167,6 +167,11 @@ xdg_output_v1_handle_logical_size (void *data,
   self->logical.width = width;
   self->logical.height = height;
 
+  if ((self->width > self->height && width < height) ||
+      (self->width < self->height && width > height))
+    self->scale = (double) self->width / (double) height;
+  else
+    self->scale = (double) self->width / (double) width;
 }
 
 static void
diff --git a/src/monitor/monitor.h b/src/monitor/monitor.h
index 720bf7d..c49a7f0 100644
--- a/src/monitor/monitor.h
+++ b/src/monitor/monitor.h
@@ -66,7 +66,8 @@ struct _PhoshMonitor {
 
   gint x, y, width, height;
   gint subpixel;
-  gint32 transform, scale;
+  gint32 transform;
+  gdouble scale;
 
   struct {
     gint32 x, y, width, height;
diff --git a/src/shell.c b/src/shell.c
index 738b5dc..13d28f7 100644
--- a/src/shell.c
+++ b/src/shell.c
@@ -831,7 +831,7 @@ phosh_shell_get_usable_area (PhoshShell *self, gint *x, gint *y, gint *width, gi
   PhoshMonitor *monitor;
   PhoshMonitorMode *mode;
   gint w, h;
-  gint scale;
+  double scale;
 
   g_return_if_fail (PHOSH_IS_SHELL (self));
 
@@ -840,9 +840,9 @@ phosh_shell_get_usable_area (PhoshShell *self, gint *x, gint *y, gint *width, gi
   mode = phosh_monitor_get_current_mode (monitor);
   g_return_if_fail (mode != NULL);
 
-  scale = monitor->scale ? monitor->scale : 1;
+  scale = (monitor->scale > 0) ? monitor->scale : 1.0;
 
-  g_debug ("Primary monitor %p scale is %d, transform is %d",
+  g_debug ("Primary monitor %p scale is %lf, transform is %d",
            monitor,
            monitor->scale,
            monitor->transform);
-- 
2.26.1
