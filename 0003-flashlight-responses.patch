From 4543f3a746f69bf21e09448fdb0b5c1bc0609a17 Mon Sep 17 00:00:00 2001
From: clover <m.alexanderrobinson@yahoo.com>
Date: Mon, 3 Aug 2020 22:37:11 -0500
Subject: [PATCH] flashlight widget responding to touch

---
 src/flashlightinfo.c    |  4 ++--
 src/settings.c          | 25 +++++++++++++++++++++++++
 src/ui/settings-menu.ui |  2 +-
 3 files changed, 28 insertions(+), 3 deletions(-)

diff --git a/src/flashlightinfo.c b/src/flashlightinfo.c
index c06cda9..1aa1742 100644
--- a/src/flashlightinfo.c
+++ b/src/flashlightinfo.c
@@ -59,11 +59,11 @@ phosh_flashlight_info_init (PhoshFlashlightInfo *self)
 {
   phosh_status_icon_set_icon_name (PHOSH_STATUS_ICON (self), "display-brightness-symbolic");
   phosh_status_icon_set_info (PHOSH_STATUS_ICON (self), "Off");
-  set_flashlight_status(1);  
+  set_flashlight_status(0);  
 }
 
 GtkWidget *
 phosh_flashlight_info_new (void)
 {
   return g_object_new (PHOSH_TYPE_FLASHLIGHT_INFO, NULL);
-}
+}
\ No newline at end of file
diff --git a/src/settings.c b/src/settings.c
index c4c5a00..59398d8 100644
--- a/src/settings.c
+++ b/src/settings.c
@@ -77,6 +77,9 @@ typedef struct _PhoshSettings
   /* KeyboardEvents */
   PhoshKeyboardEvents *keyboard_events;
   GHashTable *accelerator_callbacks;
+  
+  /* Flashlight */
+  GtkWidget *flashlightinfo;  
 } PhoshSettings;
 
 
@@ -121,6 +124,26 @@ feedback_setting_clicked_cb (PhoshSettin
 }
 
 static void
+flashlight_setting_clicked_cb (PhoshSettings *self)
+{
+  bool currently_on = get_flashlight_status() == 1;
+  bool currently_off = get_flashlight_status() == 0;
+
+  if (currently_on)
+  {
+    phosh_status_icon_set_icon_name(PHOSH_STATUS_ICON (self->flashlightinfo), "display-brightness-symbolic");
+    phosh_status_icon_set_info (PHOSH_STATUS_ICON (self->flashlightinfo), "Off");
+    set_flashlight_status(0);
+  }
+  if (currently_off)
+  {
+    phosh_status_icon_set_icon_name(PHOSH_STATUS_ICON (self->flashlightinfo), "weather-clear-symbolic");
+    phosh_status_icon_set_info (PHOSH_STATUS_ICON (self->flashlightinfo), "On");
+    set_flashlight_status(1);
+  }
+}
+
+static void
 wifi_setting_clicked_cb (PhoshSettings *self)
 {
   phosh_quick_setting_open_settings_panel ("wifi");
@@ -543,6 +566,7 @@ phosh_settings_class_init (PhoshSettings
   gtk_widget_class_bind_template_child (widget_class, PhoshSettings, quick_settings);
   gtk_widget_class_bind_template_child (widget_class, PhoshSettings, scale_brightness);
   gtk_widget_class_bind_template_child (widget_class, PhoshSettings, sw_notifications);
+  gtk_widget_class_bind_template_child (widget_class, PhoshSettings, flashlightinfo);
 
   gtk_widget_class_bind_template_callback (widget_class, battery_setting_clicked_cb);
   gtk_widget_class_bind_template_callback (widget_class, bt_setting_clicked_cb);
@@ -551,6 +575,7 @@ phosh_settings_class_init (PhoshSettings
   gtk_widget_class_bind_template_callback (widget_class, feedback_setting_long_pressed_cb);
   gtk_widget_class_bind_template_callback (widget_class, on_media_player_raised);
   gtk_widget_class_bind_template_callback (widget_class, rotation_setting_clicked_cb);
+  gtk_widget_class_bind_template_callback (widget_class, flashlight_setting_clicked_cb);
   gtk_widget_class_bind_template_callback (widget_class, torch_setting_clicked_cb);
   gtk_widget_class_bind_template_callback (widget_class, wifi_setting_clicked_cb);
   gtk_widget_class_bind_template_callback (widget_class, wwan_setting_clicked_cb);
--- a/src/ui/settings-menu.ui	2020-10-09 16:06:01.915676457 +0200
+++ b/src/ui/settings-menu.ui	2020-10-09 16:20:19.722333908 +0200
@@ -120,13 +120,13 @@
                   </object>
                 </child>
                 <child>
-                  <object class="PhoshQuickSetting" id="torch_quick_setting">
+                  <object class="PhoshQuickSetting">
                     <property name="visible">True</property>
-                    <property name="sensitive" bind-source="torchinfo" bind-property="present" bind-flags="sync-create"/>
                     <property name="can_focus">False</property>
-                    <signal name="clicked" handler="torch_setting_clicked_cb" object="PhoshSettings" swapped="yes"/>
+                    <signal name="clicked" handler="flashlight_setting_clicked_cb" object="PhoshSettings" swapped="yes"/>
+                    <signal name="clicked" handler="flashlight_setting_clicked_cb" object="PhoshSettings" swapped="yes" />
                     <child>
-                      <object class="PhoshTorchInfo" id="torchinfo">
+                      <object class="PhoshFlashlightInfo" id="flashlightinfo">
                         <property name="visible">True</property>
                         <property name="can_focus">False</property>
                         <property name="icon-size">GTK_ICON_SIZE_LARGE_TOOLBAR</property>   
